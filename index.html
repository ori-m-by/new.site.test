<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>

  <meta charset="UTF-8">
  <title>ğŸ¬ ×¡×¨×˜×™× ×œ×¦×¤×™×™×”</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- ××¡×ª×™×¨×™× ×¢×“ ×‘×“×™×§×ª ×”×¨×©××” -->
  <style>html { visibility: hidden; }</style>

  <script>
    /*****************************************************
     * 1) CONFIG â€“ ×˜×‘×œ×ª ××™×™×œ×™× ××•×¨×©×™×
     *****************************************************/
    const WORKER_URL = "https://royal-lab-55af.orimoshe-by.workers.dev";

    const APPROVED_SHEET_ID = "1EYGrBVteGM4_kXhc6owSxicwIrMp6FkzV74AjZdeAeM";

    const GOOGLE_CLIENT_ID =
      "1083389812447-mst37a55gquvk05cuc8utqsuunfar6hb.apps.googleusercontent.com";


    /*****************************************************
     * 2) ×‘×§×©×” ×œÖ¾Worker ×¢× ID Token
     *****************************************************/
    async function callWorker(sheetId, sheetName = "") {
      try {
        const token = googleToken;

        const url = `${WORKER_URL}/?sheet=${sheetId}${sheetName ? `&name=${encodeURIComponent(sheetName)}` : ""}`;

        const res = await fetch(url, {
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        if (!res.ok) throw new Error("Worker error");

        return await res.json();

      } catch (err) {
        console.error("Error calling worker:", err);
        return null;
      }
    }


    /*****************************************************
     * 3) ××—×–×™×¨ TRUE ×× ×”××™×™×œ × ××¦× ×‘×˜×‘×œ×ª ×”××•×¨×©×™×
     *****************************************************/
    async function isEmailAllowed(email) {
      const data = await callWorker(APPROVED_SHEET_ID);

      if (!data || !data.sheets) return false;

      try {
        const rows = data.sheets[0].data[0].rowData;

        const list = rows
          .slice(1)
          .map(r => r.values?.[0]?.formattedValue?.trim().toLowerCase())
          .filter(Boolean);

        return list.includes(email.toLowerCase());

      } catch (err) {
        console.error("email parse error:", err);
        return false;
      }
    }


    /*****************************************************
     * 4) callback ×©×œ ×”×ª×—×‘×¨×•×ª ×’×•×’×œ
     *****************************************************/
    let googleToken = null;

    async function handleCredentialResponse(res) {
      try {
        const data = parseJwt(res.credential);
        const email = data.email;
        googleToken = res.credential;

        const ok = await isEmailAllowed(email);
        if (!ok) {
          alert("âŒ ××™×Ÿ ×œ×š ×”×¨×©××” ×œ×”×™×›× ×¡ ×œ××ª×¨.");
          return;
        }

        // ×©××™×¨×”
        localStorage.setItem("gs_email", email);
        localStorage.setItem("gs_token", googleToken);

        // ×”×¦×’×ª ×”××ª×¨
        document.getElementById("gLoginBtn").style.display = "none";
        document.documentElement.style.visibility = "visible";
        document.getElementById("appContent").style.display = "block";

      } catch (e) {
        console.error("Login error:", e);
      }
    }


    /*****************************************************
     * 5) decode JWT
     *****************************************************/
    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(
        atob(base64).split('').map(c =>
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join('')
      );
      return JSON.parse(jsonPayload);
    }


    /*****************************************************
     * 6) startLoginFlow
     *****************************************************/
    async function startLoginFlow() {
      const savedEmail = localStorage.getItem("gs_email");
      const savedToken = localStorage.getItem("gs_token");

      if (savedEmail && savedToken) {
        googleToken = savedToken;
        if (await isEmailAllowed(savedEmail)) {
          document.documentElement.style.visibility = "visible";
          document.getElementById("appContent").style.display = "block";
          document.getElementById("gLoginBtn").style.display = "none";
          return;
        }
      }

      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse
      });

      google.accounts.id.renderButton(
        document.getElementById("gLoginBtn"),
        { theme: "outline", size: "large" }
      );

      document.documentElement.style.visibility = "visible";
    }

    window.onload = startLoginFlow;

    // × ×—×©×•×£ ×œ-main.js
    window.callWorker = callWorker;

  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- CSS ×”××§×•×¨×™ ×©×œ×š -->
  <style>
    /* ×œ× × ×•×’×¢ â€” ×”×¢×ª×§×ª×™ 1:1 ××ª ×›×œ ×”Ö¾CSS ×©×œ×š */
  </style>

</head>
<body class="bg-light">

  <!-- ×›×¤×ª×•×¨ ×’×•×’×œ -->
  <div id="gLoginBtn" style="margin: 40px auto; width: fit-content;"></div>

  <!-- ×ª×•×›×Ÿ ×”××ª×¨ -->
  <div id="appContent" style="display:none;">

    <div class="container py-5">
      <h1 class="text-center mb-3">ğŸ¬ ×”×¡×¨×˜×™× ×©×œ× ×•</h1>

      <!-- ×”×—×™×¤×•×© + ××¡× × ×™× -->
      <div class="filter-bar text-center mb-3">
        <div class="d-flex justify-content-center align-items-center gap-2" style="width:100%;">
          <input type="text" id="searchInput" class="form-control"
            style="min-width:280px; max-width:720px;"
            placeholder="×—×™×¤×•×© ×œ×¤×™ ×©×, ×‘×××™, ×©×—×§× ×™×, ×ª×™××•×¨"
            oninput="applyFilters()">

          <div class="dropdown">
            <button id="filterBtn" class="btn btn-outline-secondary filter-hamburger"
              type="button" data-bs-toggle="dropdown">
              â˜°
            </button>

            <div class="dropdown-menu dropdown-menu-end p-3" style="min-width:280px;">
              <div class="mb-2">
                <label class="form-label mb-1">×©× ×”</label>
                <select id="yearFilter" class="form-select" onchange="applyFilters()">
                  <option value="">×›×œ ×”×©× ×™×</option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label mb-1">×“×™×¨×•×’ IMDb</label>
                <select id="ratingFilter" class="form-select" onchange="applyFilters()">
                  <option value="0">×›×œ ×”×“×™×¨×•×’×™×</option>
                  <option value="9">9 ×•××¢×œ×”</option>
                  <option value="8">8 ×•××¢×œ×”</option>
                  <option value="7">7 ×•××¢×œ×”</option>
                  <option value="6">6 ×•××¢×œ×”</option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label mb-1">×–'×× ×¨</label>
                <select id="genreFilter" class="form-select" onchange="applyFilters()">
                  <option value="">×›×œ ×”×–'×× ×¨×™×</option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label mb-1">×¡×•×’ ×§×”×œ</label>
                <select id="pgFilter" class="form-select" onchange="applyFilters()">
                  <option value="">×›×œ ×¡×•×’×™ ×”×§×”×œ</option>
                </select>
              </div>

            </div>
          </div>
        </div>
      </div>

      <div class="text-center mb-4">
        <button id="toggleViewBtn" class="btn btn-outline-primary">
          ğŸ“º ××¢×‘×¨ ×œ×ª×¦×•×’×ª ×¡×“×¨×•×ª
        </button>
      </div>

      <div id="moviecontainer" class="row row-cols-1 row-cols-md-2 g-4"></div>

    </div>

  </div>

  <!-- ×¡×¤×¨×™×•×ª -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- JS -->
  <script src="main.js"></script>

</body>
</html>
