<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>ğŸ¬ ×¡×¨×˜×™× ×œ×¦×¤×™×™×”</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google Identity -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- PapaParse (× ×“×¨×© ×œ×¤× ×™ ×”××™××•×ª) -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        html { visibility: hidden; }
        body { background: #f7f7f7; }
        #blockScreen {
            display: none; position: fixed; top:0; left:0;
            width:100vw; height:100vh; background:white;
            z-index:9999; text-align:center; padding:40px;
        }
    </style>

    <script>
        /*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           CONFIG
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
        const GOOGLE_CLIENT_ID = "1083389812447-mst37a55gquvk05cuc8utqsuunfar6hb.apps.googleusercontent.com";
        const AUTH_CSV_URL = "https://docs.google.com/spreadsheets/d/1EYGrBVteGM4_kXhc6owSxicwIrMp6FkzV74AjZdeAeM/export?format=csv&gid=0";

        /*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           SHOW BLOCK SCREEN
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
        function showBlockScreen() {
            document.getElementById("blockScreen").style.display = "block";
            document.documentElement.style.visibility = "visible";
        }

        /*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           CSV AUTH FUNCTION â€” × ××¦× ×¤×”, ×‘-index!
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
        async function isEmailAllowed(email) {
            try {
                const response = await fetch(AUTH_CSV_URL);
                if (!response.ok) return false;

                const text = await response.text();
                const clean = text.replace(/^\uFEFF/, "");
                const rows = clean.split("\n");

                const emails = rows
                    .slice(1)
                    .map(r => r.split(",")[0].trim().toLowerCase());

                return emails.includes(email.toLowerCase());
            } catch (e) {
                console.error("CSV AUTH ERROR:", e);
                return false;
            }
        }

        /*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           GOOGLE LOGIN CALLBACK
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
        async function handleCredentialResponse(response) {
            try {
                const data = JSON.parse(atob(response.credential.split('.')[1]));
                const email = data.email;

                const allowed = await isEmailAllowed(email);
                if (!allowed) {
                    localStorage.removeItem("gs_auth_email");
                    return showBlockScreen();
                }

                // success
                localStorage.setItem("gs_auth_email", email);
                loadApp();

            } catch (err) {
                console.error("Login err:", err);
                showBlockScreen();
            }
        }

        /*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           LOAD MAIN.JS AFTER AUTH ONLY
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
        function loadApp() {
            document.documentElement.style.visibility = "visible";
            document.getElementById("appContent").style.display = "block";

            const s = document.createElement("script");
            s.src = "main.js?v=" + Date.now();
            document.body.appendChild(s);
        }

        /*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           START LOGIN FLOW
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
        async function startLoginFlow() {
            const saved = localStorage.getItem("gs_auth_email");
            if (saved) {
                if (await isEmailAllowed(saved)) return loadApp();
                else localStorage.removeItem("gs_auth_email");
            }

            google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: handleCredentialResponse
            });

            google.accounts.id.renderButton(
                document.getElementById("gLoginBtn"),
                { theme: "outline", size: "large" }
            );

            document.documentElement.style.visibility = "visible";
        }

        window.onload = startLoginFlow;
    </script>
</head>

<body>
    <div id="blockScreen">
        <h1>ğŸš« ××™×Ÿ ×’×™×©×”</h1>
        <p>×”××™×™×œ ×©×œ×š ×œ× ×××•×©×¨.</p>
    </div>

    <div id="gLoginBtn" style="margin:40px auto; width:fit-content;"></div>

    <div id="appContent" style="display:none;">
        <div class="container py-5">
            <h1 class="text-center mb-4">ğŸ¬ ×”×¡×¨×˜×™× ×©×œ× ×•</h1>

            <button id="toggleViewBtn" class="btn btn-outline-primary mb-4">
                ğŸ“º ××¢×‘×¨ ×œ×¡×“×¨×•×ª
            </button>

            <div class="filter-bar text-center mb-4">
                <input type="text" id="searchInput" class="form-control" placeholder="×—×™×¤×•×©..." oninput="applyFilters()">
                <select id="yearFilter" class="form-select mt-2"></select>
                <select id="ratingFilter" class="form-select mt-2">
                    <option value="0">×›×œ ×”×“×™×¨×•×’×™×</option>
                    <option value="9">9+</option>
                    <option value="8">8+</option>
                    <option value="7">7+</option>
                    <option value="6">6+</option>
                </select>
                <select id="genreFilter" class="form-select mt-2"></select>
                <select id="pgFilter" class="form-select mt-2"></select>
            </div>

            <div id="moviecontainer" class="row row-cols-1 row-cols-md-2 g-4"></div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    </div>
</body>
</html>
